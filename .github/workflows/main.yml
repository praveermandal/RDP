name: 24x7_Turbo_RDP_Master_V14

on:
  workflow_dispatch:
    inputs:
      session_count:
        default: '1'
  schedule:
    - cron: '0 */6 * * *'

jobs:
  build:
    runs-on: windows-latest
    timeout-minutes: 350

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Cleanup History
        shell: bash
        run: |
          gh run list --workflow 24x7_Turbo_RDP_Master_V14 --status completed --limit 50 | cut -f7 | xargs -I{} gh run delete {} || true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Tailscale & Dashboard Cleanup
        shell: powershell
        env:
          TS_API_KEY: ${{ secrets.TS_API_KEY }}
          TS_TAILNET: ${{ secrets.TS_TAILNET }}
          TS_AUTHKEY: ${{ secrets.TS_AUTHKEY }}
        run: |
          $count = "${{ github.event.inputs.session_count }}"
          if (-not $count) { $count = "1" }
          $prevCount = [int]$count - 1
          
          if ($prevCount -gt 0 -and $env:TS_API_KEY -and $env:TS_TAILNET) {
              $authHeader = @{ Authorization = "Basic $( [Convert]::ToBase64String([Text.Encoding]::ASCII.GetBytes("$($env:TS_API_KEY):")) )" }
              $url = "https://api.tailscale.com/api/v2/tailnet/$($env:TS_TAILNET)/devices"
              $devices = Invoke-RestMethod -Uri $url -Headers $authHeader
              $oldDevice = $devices.devices | Where-Object { $_.hostname -eq "cloud-pc-$prevCount" }
              if ($oldDevice) { Invoke-RestMethod -Uri "https://api.tailscale.com/api/v2/device/$($oldDevice.id)" -Method Delete -Headers $authHeader }
          }

          Invoke-WebRequest -Uri https://pkgs.tailscale.com/stable/tailscale-setup-latest.exe -OutFile tailscale-setup.exe
          Start-Process -FilePath .\tailscale-setup.exe -ArgumentList "/quiet", "/norestart" -Wait
          & "C:\Program Files\Tailscale\tailscale.exe" up --authkey "$env:TS_AUTHKEY" --hostname "cloud-pc-$count" --force-reauth

      - name: Get IP & Configure RDP
        shell: powershell
        run: |
          $Password = ConvertTo-SecureString "GithubRDP123!" -AsPlainText -Force
          Set-LocalUser -Name "runneradmin" -Password $Password
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"

          for ($i=1; $i -le 12; $i++) {
              $status = & "C:\Program Files\Tailscale\tailscale.exe" status --json | ConvertFrom-Json
              $FoundIP = $status.Self.TailscaleIPs[0]
              if ($FoundIP) { 
                  echo "FINAL_IP=$FoundIP" >> $env:GITHUB_ENV
                  break 
              }
              Start-Sleep -Seconds 5
          }

      - name: Send Notification (Bash Fix)
        shell: bash
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_TO: ${{ secrets.TELEGRAM_TO }}
          COUNT: ${{ github.event.inputs.session_count }}
          IP: ${{ env.FINAL_IP }}
        run: |
          # Bash is much more stable with masked secrets (***)
          MESSAGE="ðŸš€ *RDP ONLINE (Session #$COUNT)*%0A%0A*Hostname:* cloud-pc-$COUNT%0A*IP:* ${IP:-N/A}%0A*User:* runneradmin%0A*Pass:* GithubRDP123!"
          
          curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_TOKEN/sendMessage" \
            -d "chat_id=$TELEGRAM_TO" \
            -d "text=$MESSAGE" \
            -d "parse_mode=Markdown"

      - name: Keep-Alive
        shell: powershell
        run: Start-Sleep -Seconds 20000

      - name: TRIGGER NEXT CYCLE (Bash Fix)
        if: always()
        shell: bash
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_TO: ${{ secrets.TELEGRAM_TO }}
        run: |
          if [ -f "STOP" ]; then
            echo "Stop file found. Terminating loop."
            curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_TOKEN/sendMessage" \
              -d "chat_id=$TELEGRAM_TO" \
              -d "text=ðŸ›‘ *LOOP TERMINATED*" \
              -d "parse_mode=Markdown"
          else
            NEW_COUNT=$(( ${{ github.event.inputs.session_count }} + 1 ))
            gh workflow run 24x7_Turbo_RDP_Master_V14 -f session_count=$NEW_COUNT
          fi
