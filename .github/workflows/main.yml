name: RDP-247

on:
  workflow_dispatch:
    inputs:
      session_count:
        default: '1'
  schedule:
    - cron: '0 */6 * * *'

jobs:
  # --- ALPHA RDP ---
  Alpha:
    runs-on: windows-latest
    timeout-minutes: 350
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check Killswitch
        shell: bash
        run: '[ -f "STOP_ALPHA" ] && exit 1 || exit 0'

      - name: Setup Tailscale
        shell: powershell
        env:
          TS_AUTHKEY: ${{ secrets.TS_AUTHKEY }}
        run: |
          Invoke-WebRequest -Uri https://pkgs.tailscale.com/stable/tailscale-setup-latest.exe -OutFile ts.exe
          Start-Process -FilePath .\ts.exe -ArgumentList "/quiet", "/norestart" -Wait
          & "C:\Program Files\Tailscale\tailscale.exe" up --authkey "$env:TS_AUTHKEY" --hostname "RDP-Alpha-${{ github.event.inputs.session_count }}" --force-reauth

      - name: Configure RDP & IP
        shell: powershell
        run: |
          $Password = ConvertTo-SecureString "GithubRDP123!" -AsPlainText -Force
          Set-LocalUser -Name "runneradmin" -Password $Password
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          for ($i=1; $i -le 10; $i++) {
              $ip = (& "C:\Program Files\Tailscale\tailscale.exe" ip -4)
              if ($ip) { echo "FINAL_IP=$ip" >> $env:GITHUB_ENV; break }
              Start-Sleep -Seconds 5
          }

      - name: Notify Alpha (With Button)
        shell: bash
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_TO: ${{ secrets.TELEGRAM_TO }}
        run: |
          IP="${{ env.FINAL_IP }}"
          RDP_URL="rdp://full%20address=s:$IP:3389&username=s:runneradmin"
          
          # Use JSON to create a real Inline Button
          curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_TOKEN/sendMessage" \
            -H "Content-Type: application/json" \
            -d @- <<EOF
          {
            "chat_id": "$TELEGRAM_TO",
            "text": "ðŸ…°ï¸ *ALPHA ONLINE*\nIP: \`$IP\`\nPass: \`GithubRDP123!\`",
            "parse_mode": "Markdown",
            "reply_markup": {
              "inline_keyboard": [[
                { "text": "âš¡ Connect to Alpha", "url": "$RDP_URL" }
              ]]
            }
          }
          EOF

      - name: Keep-Alive
        shell: powershell
        run: Start-Sleep -Seconds 20000

  # --- BRAVO RDP ---
  Bravo:
    runs-on: windows-latest
    timeout-minutes: 350
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check Killswitch
        shell: bash
        run: '[ -f "STOP_BRAVO" ] && exit 1 || exit 0'

      - name: Setup Tailscale
        shell: powershell
        env:
          TS_AUTHKEY: ${{ secrets.TS_AUTHKEY }}
        run: |
          Invoke-WebRequest -Uri https://pkgs.tailscale.com/stable/tailscale-setup-latest.exe -OutFile ts.exe
          Start-Process -FilePath .\ts.exe -ArgumentList "/quiet", "/norestart" -Wait
          & "C:\Program Files\Tailscale\tailscale.exe" up --authkey "$env:TS_AUTHKEY" --hostname "RDP-Bravo-${{ github.event.inputs.session_count }}" --force-reauth

      - name: Configure RDP & IP
        shell: powershell
        run: |
          $Password = ConvertTo-SecureString "GithubRDP123!" -AsPlainText -Force
          Set-LocalUser -Name "runneradmin" -Password $Password
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          for ($i=1; $i -le 10; $i++) {
              $ip = (& "C:\Program Files\Tailscale\tailscale.exe" ip -4)
              if ($ip) { echo "FINAL_IP=$ip" >> $env:GITHUB_ENV; break }
              Start-Sleep -Seconds 5
          }

      - name: Notify Bravo (With Button)
        shell: bash
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_TO: ${{ secrets.TELEGRAM_TO }}
        run: |
          IP="${{ env.FINAL_IP }}"
          RDP_URL="rdp://full%20address=s:$IP:3389&username=s:runneradmin"
          
          curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_TOKEN/sendMessage" \
            -H "Content-Type: application/json" \
            -d @- <<EOF
          {
            "chat_id": "$TELEGRAM_TO",
            "text": "ðŸ…±ï¸ *BRAVO ONLINE*\nIP: \`$IP\`\nPass: \`GithubRDP123!\`",
            "parse_mode": "Markdown",
            "reply_markup": {
              "inline_keyboard": [[
                { "text": "âš¡ Connect to Bravo", "url": "$RDP_URL" }
              ]]
            }
          }
          EOF

      - name: Keep-Alive
        shell: powershell
        run: Start-Sleep -Seconds 20000

  # --- TRIGGER & CLEANUP ---
  Trigger:
    needs: [Alpha, Bravo]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Auto-Loop Logic
        shell: bash
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_TO: ${{ secrets.TELEGRAM_TO }}
        run: |
          gh run list --workflow RDP-247 --status completed --limit 50 | cut -f7 | xargs -I{} gh run delete {} || true
          CURRENT_COUNT=${{ github.event.inputs.session_count }}
          if (( $CURRENT_COUNT % 4 == 0 )); then
            DAYS=$(( $CURRENT_COUNT / 4 ))
            curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_TOKEN/sendMessage" -d "chat_id=$TELEGRAM_TO" -d "text=ðŸ“Š *DAILY STATUS*%0AUptime: $DAYS Day(s)" -d "parse_mode=Markdown"
          fi
          if [ -f "STOP" ]; then
            curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_TOKEN/sendMessage" -d "chat_id=$TELEGRAM_TO" -d "text=ðŸ›‘ *SYSTEM STOPPED*"
          else
            NEXT=$(( $CURRENT_COUNT + 1 ))
            gh workflow run RDP-247 -f session_count=$NEXT
          fi
