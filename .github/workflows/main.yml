name: 24x7_Turbo_RDP_Master_V9

on:
  workflow_dispatch:
    inputs:
      session_count:
        default: '1'
  schedule:
    - cron: '0 */6 * * *'

jobs:
  build:
    runs-on: windows-latest
    timeout-minutes: 350

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Cleanup History
        shell: bash
        run: |
          gh run list --workflow 24x7_Turbo_RDP_Master_V9 --status completed --limit 50 | cut -f7 | xargs -I{} gh run delete {} || true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Tailscale & Dashboard Cleanup
        shell: powershell
        run: |
          $count = "${{ github.event.inputs.session_count }}"
          if (-not $count) { $count = "1" }
          $prevCount = [int]$count - 1
          
          # Cleanup previous session from Dashboard
          if ($prevCount -gt 0) {
              $authHeader = @{ Authorization = "Basic $( [Convert]::ToBase64String([Text.Encoding]::ASCII.GetBytes("${{ secrets.TS_API_KEY }}:")) )" }
              $url = "https://api.tailscale.com/api/v2/tailnet/${{ secrets.TS_TAILNET }}/devices"
              $devices = Invoke-RestMethod -Uri $url -Headers $authHeader
              $oldDevice = $devices.devices | Where-Object { $_.hostname -eq "cloud-pc-$prevCount" }
              if ($oldDevice) { Invoke-RestMethod -Uri "https://api.tailscale.com/api/v2/device/$($oldDevice.id)" -Method Delete -Headers $authHeader }
          }

          # Install Tailscale
          Invoke-WebRequest -Uri https://pkgs.tailscale.com/stable/tailscale-setup-latest.exe -OutFile tailscale-setup.exe
          Start-Process -FilePath .\tailscale-setup.exe -ArgumentList "/quiet", "/norestart" -Wait
          
          # Start Tailscale
          $TS_PATH = "C:\Program Files\Tailscale\tailscale.exe"
          & $TS_PATH up --authkey ${{ secrets.TS_AUTHKEY }} --hostname "cloud-pc-$count" --force-reauth

      - name: Get IP (JSON Method) & Configure RDP
        shell: powershell
        run: |
          # 1. Setup User
          $Password = ConvertTo-SecureString "GithubRDP123!" -AsPlainText -Force
          Set-LocalUser -Name "runneradmin" -Password $Password
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"

          # 2. Extract IP via JSON (The most reliable way)
          Write-Host "Searching for Tailscale IP..."
          $TS_PATH = "C:\Program Files\Tailscale\tailscale.exe"
          $FoundIP = ""
          
          for ($i=1; $i -le 12; $i++) {
              $status = & $TS_PATH status --json | ConvertFrom-Json
              $FoundIP = $status.Self.TailscaleIPs[0]
              
              if ($FoundIP) { 
                  Write-Host "âœ… SUCCESS: Found IP $FoundIP"
                  echo "FINAL_IP=$FoundIP" >> $env:GITHUB_ENV
                  break 
              }
              Write-Host "Retrying IP search... ($i/12)"
              Start-Sleep -Seconds 5
          }

      - name: Send Notification
        shell: powershell
        run: |
          $count = "${{ github.event.inputs.session_count }}"
          $ip = "${{ env.FINAL_IP }}"
          if (-not $ip) { $ip = "IP_NOT_FOUND" }
          
          $msg = "ðŸš€ *RDP ONLINE (Session #$count)*`n`n*Hostname:* `cloud-pc-$count` `n*IP:* ``$ip`` `n*User:* `runneradmin` `n*Pass:* `GithubRDP123!`"
          $payload = @{ chat_id = "${{ secrets.TELEGRAM_TO }}"; text = $msg; parse_mode = "Markdown" } | ConvertTo-Json
          Invoke-RestMethod -Uri "https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage" -Method Post -ContentType "application/json" -Body ([System.Text.Encoding]::UTF8.GetBytes($payload))

      - name: Keep-Alive
        shell: powershell
        run: Start-Sleep -Seconds 20000

      - name: TRIGGER NEXT CYCLE
        if: always()
        shell: bash
        run: |
          if [ -f "STOP" ]; then
            MSG="ðŸ›‘ *LOOP TERMINATED*"
            curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage" -d "chat_id=${{ secrets.TELEGRAM_TO }}&text=$MSG"
          else
            NEW_COUNT=$(( ${{ github.event.inputs.session_count }} + 1 ))
            gh workflow run 24x7_Turbo_RDP_Master_V9 -f session_count=$NEW_COUNT
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
